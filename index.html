<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent (Refined)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
        }

        .voice-agent-container {
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 300px;
        }

        /* --- Session Info --- */
        .session-info {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 20px;
        }

        /* --- Mic and Status (Listening/Generating) --- */
        .mic-section {
            margin-bottom: 30px;
        }

        #mic-icon {
            font-size: 4em;
            color: #ccc;
            transition: color 0.3s;
        }

        #mic-icon.recording {
            color: #e74c3c; /* Red color when recording */
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .status-message {
            margin-top: 15px;
            font-weight: bold;
            color: #333;
            min-height: 20px; /* To prevent layout shift */
        }

        /* --- Buttons --- */
        .controls-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hidden {
            display: none !important;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .main-btn {
            background-color: #3498db; /* Blue */
            color: white;
        }

        .main-btn:hover {
            background-color: #2980b9;
        }

        .action-btn.send {
            background-color: #2ecc71; /* Green */
            color: white;
        }

        .action-btn.send:hover {
            background-color: #27ae60;
        }

        .action-btn.end {
            background-color: #95a5a6; /* Gray */
            color: white;
        }

        .action-btn.end:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>

    <div class="voice-agent-container">
        <p class="session-info">
            Session ID: <span id="session-id">Loading...</span>
        </p>

        <div class="mic-section">
            <i id="mic-icon" class="fas fa-microphone" aria-hidden="true"></i>
            <p id="status-message" class="status-message">Click "Start Conversation" to begin.</p>
        </div>

        <div id="controls-initial" class="controls-group">
            <button id="start-conversation-btn" class="main-btn">Start Conversation</button>
        </div>

        <div id="controls-recording" class="controls-group hidden">
            <button id="send-voice-btn" class="action-btn send">Send Voice</button>
            <button id="end-call-btn" class="action-btn end">End Call</button>
        </div>

        <div id="controls-ready-to-record" class="controls-group hidden">
            <button id="record-voice-btn" class="main-btn">Record Voice</button>
            <button id="end-call-btn-2" class="action-btn end">End Call</button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const sessionIdDisplay = document.getElementById('session-id');
            const startBtn = document.getElementById('start-conversation-btn');
            const sendBtn = document.getElementById('send-voice-btn');
            const endCallBtn = document.getElementById('end-call-btn');
            const endCallBtn2 = document.getElementById('end-call-btn-2');
            const recordVoiceBtn = document.getElementById('record-voice-btn');
            const micIcon = document.getElementById('mic-icon');
            const statusMessage = document.getElementById('status-message');

            const controlsInitial = document.getElementById('controls-initial');
            const controlsRecording = document.getElementById('controls-recording');
            const controlsReadyToRecord = document.getElementById('controls-ready-to-record');

            // --- State and Constants ---
            let mediaRecorder;
            let audioChunks = [];
            let stream; // Microphone stream
            let sessionId;
            const N8N_WEBHOOK_URL = 'https://devkhemani.app.n8n.cloud/webhook-test/voice-agent';

            // --- UI Management ---

            function generateSessionId() {
                // Simple 8-character hex string for session tracking
                return Math.random().toString(16).slice(2, 10);
            }

            function updateUI(state, message) {
                // Hide all control groups
                controlsInitial.classList.add('hidden');
                controlsRecording.classList.add('hidden');
                controlsReadyToRecord.classList.add('hidden');

                // Reset mic visual state
                micIcon.classList.remove('recording');
                micIcon.style.color = '#ccc';
                
                switch (state) {
                    case 'initial':
                        controlsInitial.classList.remove('hidden');
                        break;
                    case 'recording':
                        controlsRecording.classList.remove('hidden');
                        micIcon.classList.add('recording'); // Triggers pulse animation (red mic)
                        micIcon.style.color = '#e74c3c';
                        break;
                    case 'ready-to-record':
                        controlsReadyToRecord.classList.remove('hidden');
                        micIcon.style.color = '#3498db'; // Blue to indicate ready
                        break;
                }
                statusMessage.textContent = message;
            }

            // --- Stream and Recording Control ---

            function stopStream() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    console.log('Microphone stream stopped.');
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    console.log('MediaRecorder stopped.');
                }
            }


            // --- Core Logic ---

            async function startRecording() {
                // Clear previous audio data for a fresh recording
                audioChunks = []; 
                
                try {
                    updateUI('recording', 'Recording your voice... Click Send Voice to transmit.');

                    // Request stream only if not already active
                    if (!stream) {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    }

                    // Create a NEW MediaRecorder instance for this session
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    // CRITICAL: onstop triggers the function that sends the data
                    mediaRecorder.onstop = sendRecordedAudio;

                    mediaRecorder.start();
                    console.log('Recording started.');

                } catch (error) {
                    console.error('Error starting recording:', error);
                    updateUI('initial', 'Microphone access denied or error. Please allow access.');
                    stopStream();
                }
            }

            function handleSendVoice() {
                // Stop recording. This triggers the 'onstop' event, which calls sendRecordedAudio.
                stopRecording();
                updateUI('ready-to-record', 'Sending voice and awaiting response...');
            }

            async function sendRecordedAudio() {
                // Check if recording actually yielded data
                if (audioChunks.length === 0) {
                    // If no data, stop the stream and notify the user
                    stopStream(); 
                    updateUI('ready-to-record', 'Recording ended with no audio. Click Record Voice to speak again.');
                    console.warn('No audio data recorded.');
                    return;
                }

                // Create the Blob: Use the mimeType reported by the recorder for maximum compatibility
                const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                
                // Prepare FormData for the webhook (Crucial for file upload)
                const formData = new FormData();
                formData.append('voice', audioBlob, 'user_voice.webm'); // 'voice' is the expected field name in n8n
                formData.append('session_id', sessionId);

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        body: formData,
                        // Do not set Content-Type; the browser sets the correct 'multipart/form-data' boundary
                    });

                    if (response.ok) {
                        updateUI('ready-to-record', `Voice sent successfully! Click Record Voice to speak again.`);
                        console.log('Voice sent successfully. Server response:', await response.text());
                    } else {
                        updateUI('ready-to-record', `Failed to send voice. Error: ${response.status}.`);
                        console.error('Failed to send voice. Status:', response.status);
                    }
                } catch (error) {
                    console.error('Network or fetch error:', error);
                    updateUI('ready-to-record', `Network Error. Click Record Voice to try again.`);
                }
            }

            function handleEndCall() {
                stopRecording(); 
                stopStream(); // Stops mic access completely
                sessionId = null; 
                sessionIdDisplay.textContent = 'N/A';
                updateUI('initial', 'Conversation ended. Click "Start Conversation" to begin a new session.');
            }

            // --- Event Binding ---
            
            startBtn.addEventListener('click', () => {
                sessionId = generateSessionId();
                sessionIdDisplay.textContent = sessionId;
                startRecording();
            });

            recordVoiceBtn.addEventListener('click', startRecording);
            sendBtn.addEventListener('click', handleSendVoice);
            endCallBtn.addEventListener('click', handleEndCall);
            endCallBtn2.addEventListener('click', handleEndCall);

            // --- Initialization ---
            sessionIdDisplay.textContent = 'N/A';
        });
    </script>
</body>
</html>

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Adalat - Pakistani Legal Research Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              serif: ["Crimson Pro", "Georgia", "serif"],
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            colors: {
              law: {
                50: "#f8f7f5",
                100: "#f0ede8",
                200: "#e0d9cf",
                300: "#ccc1b0",
                400: "#b5a38e",
                500: "#a08870",
                600: "#856f5a",
                700: "#6c5a4a",
                800: "#594b3f",
                900: "#4a3f36",
                950: "#26201b",
              },
              gold: {
                400: "#d4af37",
                500: "#c5a028",
                600: "#b8941f",
              },
            },
            boxShadow: {
              law: "0 4px 20px -2px rgba(74, 63, 54, 0.15)",
              "law-lg": "0 10px 40px -4px rgba(74, 63, 54, 0.2)",
            },
          },
        },
      };
    </script>
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background: #4b5563;
      }

      /* Typography */
      .prose-law {
        line-height: 1.85;
        letter-spacing: -0.01em;
      }
      .prose-law p {
        margin-bottom: 1.4em;
        text-align: justify;
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .slide-in {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
        }
        to {
          transform: translateX(0);
        }
      }

      /* Highlights */
      .highlight-mark {
        background: linear-gradient(120deg, #fef08a 0%, #fef08a 100%);
        padding: 0 2px;
        border-radius: 2px;
      }
      .dark .highlight-mark {
        background: linear-gradient(120deg, #854d0e 0%, #854d0e 100%);
        color: #fef9c3;
      }

      .search-highlight {
        background-color: #dbeafe;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: 500;
      }
      .dark .search-highlight {
        background-color: #1e40af;
        color: #bfdbfe;
      }

      /* Glass effect */
      .glass {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
      }
      .dark .glass {
        background: rgba(26, 26, 26, 0.85);
      }

      /* Tooltip */
      .tooltip {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .group:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }

      /* Selection */
      ::selection {
        background: #d4af37;
        color: #26201b;
      }

      /* Focus styles */
      button:focus-visible,
      input:focus-visible {
        outline: 2px solid #d4af37;
        outline-offset: 2px;
      }
    </style>
    <base target="_blank" />
  </head>
  <body
    class="bg-law-50 text-law-900 font-sans antialiased transition-colors duration-300 dark:bg-law-950 dark:text-law-100 h-screen flex flex-col overflow-hidden selection:bg-gold-400 selection:text-law-950"
  >
    <!-- Top Navigation Bar -->
    <nav
      class="h-16 glass border-b border-law-200 dark:border-law-800 flex-none z-50 flex items-center justify-between px-4 lg:px-6"
    >
      <div class="flex items-center gap-4">
        <button
          id="sidebar-toggle"
          class="lg:hidden p-2 hover:bg-law-200 dark:hover:bg-law-800 rounded-lg transition"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
        <div
          class="flex items-center gap-3 cursor-pointer"
          onclick="app.router('dashboard')"
        >
          <div
            class="w-10 h-10 bg-gradient-to-br from-gold-400 to-gold-600 rounded-lg flex items-center justify-center shadow-law"
          >
            <span class="text-law-950 font-serif font-bold text-xl">A</span>
          </div>
          <div class="hidden sm:block">
            <h1 class="font-serif font-bold text-xl tracking-tight">Adalat</h1>
            <p class="text-xs text-law-500 dark:text-law-400 -mt-1">
              Legal Research Suite
            </p>
          </div>
        </div>
      </div>

      <!-- Global Search Bar -->
      <div class="flex-1 max-w-2xl mx-4 hidden md:block">
        <div class="relative group">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <svg
              class="h-5 w-5 text-law-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              />
            </svg>
          </div>
          <input
            type="text"
            id="global-search"
            placeholder="Search laws, sections, keywords... (Ctrl+K)"
            class="block w-full pl-10 pr-20 py-2.5 border border-law-300 dark:border-law-700 rounded-xl leading-5 bg-white dark:bg-law-900 placeholder-law-400 focus:outline-none focus:ring-2 focus:ring-gold-400 focus:border-transparent transition shadow-sm text-sm"
            onfocus="app.showSearchModal()"
            readonly
          />
          <div class="absolute inset-y-0 right-0 pr-2 flex items-center">
            <kbd
              class="hidden sm:inline-block px-2 py-1 text-xs font-semibold text-law-500 bg-law-100 dark:bg-law-800 border border-law-300 dark:border-law-600 rounded"
              >⌘K</kbd
            >
          </div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button
          onclick="app.toggleDarkMode()"
          class="p-2.5 hover:bg-law-200 dark:hover:bg-law-800 rounded-lg transition text-law-600 dark:text-law-300"
          title="Toggle Theme"
        >
          <svg
            class="w-5 h-5 hidden dark:block"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
          <svg
            class="w-5 h-5 block dark:hidden"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
          </svg>
        </button>
        <button
          onclick="app.router('profile')"
          class="flex items-center gap-2 p-1.5 pl-3 pr-1 hover:bg-law-200 dark:hover:bg-law-800 rounded-full transition"
        >
          <span class="text-sm font-medium hidden sm:block"
            >Adv. Dev Parkash</span
          >
          <div
            class="w-8 h-8 bg-law-700 dark:bg-gold-500 rounded-full flex items-center justify-center text-white dark:text-law-950 font-bold text-sm"
          >
            DP
          </div>
        </button>
      </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
      <!-- Sidebar Navigation -->
      <aside
        id="sidebar"
        class="w-64 bg-white dark:bg-law-900 border-r border-law-200 dark:border-law-800 flex-none flex flex-col transition-transform duration-300 lg:translate-x-0 -translate-x-full absolute lg:relative z-40 h-full"
      >
        <div class="p-4 space-y-1 overflow-y-auto flex-1">
          <button
            onclick="app.router('dashboard')"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg bg-law-100 dark:bg-law-800 text-law-900 dark:text-white transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            Dashboard
          </button>

          <div class="pt-4 pb-2">
            <p
              class="px-3 text-xs font-semibold text-law-400 uppercase tracking-wider"
            >
              Library
            </p>
          </div>

          <button
            onclick="app.router('library')"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-law-600 dark:text-law-300 hover:bg-law-50 dark:hover:bg-law-800 rounded-lg transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
              />
            </svg>
            All Books
          </button>

          <button
            onclick="app.router('favorites')"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-law-600 dark:text-law-300 hover:bg-law-50 dark:hover:bg-law-800 rounded-lg transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"
              />
            </svg>
            Pinned Favorites
            <span
              class="ml-auto bg-gold-400 text-law-950 text-xs font-bold px-2 py-0.5 rounded-full"
              >3</span
            >
          </button>

          <button
            onclick="app.router('folders')"
            class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-law-600 dark:text-law-300 hover:bg-law-50 dark:hover:bg-law-800 rounded-lg transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
              />
            </svg>
            Smart Folders
          </button>

          <div class="pt-4 pb-2">
            <p
              class="px-3 text-xs font-semibold text-law-400 uppercase tracking-wider"
            >
              Recent
            </p>
          </div>

          <div class="space-y-1">
            <button
              onclick="app.openBook('ppc', '302')"
              class="w-full text-left px-3 py-2 text-xs text-law-600 dark:text-law-400 hover:text-law-900 dark:hover:text-white truncate transition"
            >
              PPC - Section 302
            </button>
            <button
              onclick="app.openBook('crpc', '154')"
              class="w-full text-left px-3 py-2 text-xs text-law-600 dark:text-law-400 hover:text-law-900 dark:hover:text-white truncate transition"
            >
              CrPC - Section 154
            </button>
          </div>
        </div>

        <div class="p-4 border-t border-law-200 dark:border-law-800">
          <button
            onclick="app.downloadOffline()"
            class="w-full flex items-center gap-2 px-3 py-2 text-sm text-law-600 dark:text-law-300 hover:bg-law-50 dark:hover:bg-law-800 rounded-lg transition"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
              />
            </svg>
            Download for Offline
          </button>
        </div>
      </aside>

      <!-- Content Area -->
      <main
        id="main-content"
        class="flex-1 overflow-y-auto bg-law-50 dark:bg-law-950 relative scroll-smooth"
      >
        <!-- Views injected here -->
      </main>
    </div>

    <!-- Search Modal Overlay -->
    <div id="search-modal" class="fixed inset-0 z-[60] hidden">
      <div
        class="absolute inset-0 bg-law-950/60 backdrop-blur-sm"
        onclick="app.hideSearchModal()"
      ></div>
      <div
        class="absolute inset-x-4 top-[10%] md:inset-x-auto md:left-1/2 md:-translate-x-1/2 md:w-[600px] max-h-[80vh] bg-white dark:bg-law-900 rounded-2xl shadow-law-lg overflow-hidden flex flex-col fade-in"
      >
        <div
          class="p-4 border-b border-law-200 dark:border-law-800 flex items-center gap-3"
        >
          <svg
            class="w-6 h-6 text-law-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
          <input
            type="text"
            id="modal-search-input"
            placeholder="Search sections, keywords, or act names..."
            class="flex-1 text-lg bg-transparent border-none focus:outline-none placeholder-law-400"
            oninput="app.performSearch(this.value)"
          />
          <button
            onclick="app.hideSearchModal()"
            class="p-1 hover:bg-law-100 dark:hover:bg-law-800 rounded"
          >
            <span class="text-law-400 text-sm">ESC</span>
          </button>
        </div>
        <div id="search-results-container" class="flex-1 overflow-y-auto p-2">
          <div class="p-8 text-center text-law-500">
            <p class="mb-2">Start typing to search across all law books</p>
            <div class="flex justify-center gap-2 mt-4">
              <span
                class="px-3 py-1 bg-law-100 dark:bg-law-800 rounded-full text-xs"
                >Try: "Section 302"</span
              >
              <span
                class="px-3 py-1 bg-law-100 dark:bg-law-800 rounded-full text-xs"
                >Try: "Murder"</span
              >
              <span
                class="px-3 py-1 bg-law-100 dark:bg-law-800 rounded-full text-xs"
                >Try: "FIR"</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Annotation Modal -->
    <div
      id="annotation-modal"
      class="fixed inset-0 z-[70] hidden items-center justify-center p-4"
    >
      <div
        class="absolute inset-0 bg-law-950/70 backdrop-blur-sm"
        onclick="app.closeAnnotationModal()"
      ></div>
      <div
        class="relative bg-white dark:bg-law-900 rounded-xl shadow-law-lg w-full max-w-md p-6 fade-in"
      >
        <h3 class="text-lg font-bold mb-4">Add Note</h3>
        <textarea
          id="annotation-text"
          rows="4"
          class="w-full p-3 border border-law-300 dark:border-law-700 rounded-lg bg-law-50 dark:bg-law-800 focus:outline-none focus:ring-2 focus:ring-gold-400 resize-none"
          placeholder="Enter your notes here..."
        ></textarea>
        <div class="flex justify-end gap-3 mt-4">
          <button
            onclick="app.closeAnnotationModal()"
            class="px-4 py-2 text-law-600 hover:bg-law-100 dark:hover:bg-law-800 rounded-lg transition"
          >
            Cancel
          </button>
          <button
            onclick="app.saveAnnotation()"
            class="px-4 py-2 bg-gold-500 hover:bg-gold-600 text-white rounded-lg transition font-medium"
          >
            Save Note
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-6 right-6 z-[80] transform translate-y-20 opacity-0 transition-all duration-300"
    >
      <div
        class="bg-law-900 dark:bg-white text-white dark:text-law-900 px-6 py-3 rounded-lg shadow-law-lg flex items-center gap-3"
      >
        <svg
          class="w-5 h-5 text-gold-400 dark:text-gold-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          />
        </svg>
        <span id="toast-message" class="font-medium">Action completed</span>
      </div>
    </div>

    <script>
      // Data Store
      const lawDB = {
        books: [
          {
            id: "ppc",
            title: "Pakistan Penal Code, 1860",
            category: "Criminal",
            color: "bg-red-100 text-red-800",
            totalSections: 511,
          },
          {
            id: "crpc",
            title: "Code of Criminal Procedure, 1898",
            category: "Criminal",
            color: "bg-red-100 text-red-800",
            totalSections: 565,
          },
          {
            id: "cpc",
            title: "Civil Procedure Code, 1908",
            category: "Civil",
            color: "bg-blue-100 text-blue-800",
            totalSections: 158,
          },
          {
            id: "contract",
            title: "Contract Act, 1872",
            category: "Civil",
            color: "bg-blue-100 text-blue-800",
            totalSections: 266,
          },
          {
            id: "constitution",
            title: "Constitution of Pakistan, 1973",
            category: "Constitutional",
            color: "bg-purple-100 text-purple-800",
            totalSections: 280,
          },
          {
            id: "qanoon",
            title: "Qanun-e-Shahadat Order, 1984",
            category: "Evidence",
            color: "bg-green-100 text-green-800",
            totalSections: 172,
          },
        ],

        getSections: (bookId) => {
          const generators = {
            ppc: [
              {
                num: "299",
                title: "Definitions",
                content:
                  '<p>In this Code, unless there is anything repugnant in the subject or context:</p><p><strong>"Wrongful gain"</strong> is gain by unlawful means of property to which the person gaining is not legally entitled.</p><p><strong>"Wrongful loss"</strong> is the loss by unlawful means of property to which the person losing it is legally entitled.</p>',
              },
              {
                num: "300",
                title: "Murder",
                content:
                  "<p>Except in the cases hereinafter excepted, culpable homicide is murder, if the act by which the death is caused is done with the intention of causing death, or secondly, if it is done with the intention of causing such bodily injury as the offender knows to be likely to cause the death of the person to whom the harm is caused...</p>",
              },
              {
                num: "302",
                title: "Punishment for Murder",
                content:
                  "<p>Whoever commits qatl-i-amd shall, subject to the provisions of this Chapter be:</p><p>(a) punished with death as qisas;</p><p>(b) punished with death or imprisonment for life as ta'zir having regard to the facts and circumstances of the case, if the proof in either of the forms specified in Section 304 is not available; or</p><p>(c) punished with imprisonment of either description for a term which may extend to twenty-five years, where according to the injunctions of Islam the punishment of qisas is not applicable.</p>",
              },
              {
                num: "304",
                title: "Proof of Qatl-i-amd",
                content:
                  "<p>Proof of qatl-i-amd shall be in any of the following forms, namely:</p><p>(a) the accused makes before a Court competent to try the offence a voluntary and true confession of the commission of the offence...</p>",
              },
              {
                num: "306",
                title: "Thug",
                content:
                  "<p>Whoever, at any time after the passing of this Act, shall have been habitually associated with any other or others for the purpose of committing robbery or child-stealing by means of or accompanied with murder, is a thug.</p>",
              },
              {
                num: "320",
                title: "Grievous Hurt",
                content:
                  '<p>The following kinds of hurt only are designated as "Grievous":</p><p>First. -- Emasculation.</p><p>Secondly. -- Permanent privation of the sight of either eye.</p><p>Thirdly. -- Permanent privation of the hearing of either ear...</p>',
              },
              {
                num: "375",
                title: "Rape",
                content:
                  "<p>A man is said to commit rape who has sexual intercourse with a woman under circumstances falling under any of the five following descriptions...</p>",
              },
            ],
            crpc: [
              {
                num: "154",
                title: "Information in cognizable cases",
                content:
                  "<p>Every information relating to the commission of a cognizable offence, if given orally to an officer in charge of a police station, shall be reduced to writing by him or under his direction...</p>",
              },
              {
                num: "161",
                title: "Examination of witnesses by police",
                content:
                  "<p>Any police officer making an investigation under this Chapter, or any police officer not below such rank as the Provincial Government may, by general or special order, prescribe in this behalf, acting on the requisition of such officer, may examine orally any person supposed to be acquainted with the facts and circumstances of the case.</p>",
              },
              {
                num: "164",
                title: "Recording of confessions and statements",
                content:
                  "<p>(1) Any Metropolitan Magistrate or Judicial Magistrate may, whether or not he has jurisdiction in the case, record any confession or statement made to him in the course of an investigation...</p>",
              },
              {
                num: "173",
                title: "Report of police officer",
                content:
                  "<p>Every investigation under this Chapter shall be completed without unnecessary delay, and as soon as it is completed, the officer in charge of the police station shall forward to a Magistrate empowered to take cognizance of the offence on a police report...</p>",
              },
            ],
          };

          if (generators[bookId]) return generators[bookId];
          return Array.from({ length: 20 }, (_, i) => ({
            num: (i + 1).toString(),
            title: `Section ${i + 1}`,
            content: `<p>This is the detailed legal text for Section ${i + 1} of this Act. It contains the substantive provisions, explanations, and illustrations as per the official gazette.</p><p>The section details rights, obligations, and procedures relevant to this specific area of law.</p>`,
          }));
        },
      };

      // App State
      const app = {
        state: {
          currentView: "dashboard",
          darkMode: false,
          fontSize: "text-base",
          lineHeight: "leading-relaxed",
          sidebarOpen: true,
          activeBook: null,
          activeSection: null,
          searchQuery: "",
          bookmarks: new Set(),
          annotations: {},
          favorites: new Set(["ppc", "crpc"]),
          recentSearches: [],
          selection: null,
        },

        init() {
          this.router("dashboard");
          this.setupKeyboardShortcuts();
          this.setupTextSelection();

          // Load saved preferences
          if (localStorage.getItem("darkMode") === "true") {
            this.toggleDarkMode();
          }
        },

        router(view, params = {}) {
          this.state.currentView = view;
          const container = document.getElementById("main-content");
          container.innerHTML = "";
          window.scrollTo(0, 0);

          switch (view) {
            case "dashboard":
              this.renderDashboard(container);
              break;
            case "library":
              this.renderLibrary(container);
              break;
            case "book":
              this.renderBookReader(container, params.bookId, params.sectionId);
              break;
            case "favorites":
              this.renderFavorites(container);
              break;
            case "folders":
              this.renderFolders(container);
              break;
            case "profile":
              this.renderProfile(container);
              break;
          }
        },

        // Render Methods
        renderDashboard(container) {
          const pinnedBooks = lawDB.books.filter((b) =>
            this.state.favorites.has(b.id),
          );

          container.innerHTML = `
                    <div class="fade-in max-w-6xl mx-auto px-4 py-8 pb-24">
                        <div class="mb-8">
                            <h1 class="text-3xl font-serif font-bold text-law-900 dark:text-white mb-2">Good Morning, Advocate Dev</h1>
                            <p class="text-law-600 dark:text-law-400">Ready for today's proceedings? Here's your legal workspace.</p>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div class="bg-white dark:bg-law-900 p-4 rounded-xl border border-law-200 dark:border-law-800 shadow-sm">
                                <div class="text-2xl font-bold text-gold-600">12</div>
                                <div class="text-xs text-law-500 uppercase tracking-wide">Bookmarks</div>
                            </div>
                            <div class="bg-white dark:bg-law-900 p-4 rounded-xl border border-law-200 dark:border-law-800 shadow-sm">
                                <div class="text-2xl font-bold text-blue-600">5</div>
                                <div class="text-xs text-law-500 uppercase tracking-wide">Cases Today</div>
                            </div>
                            <div class="bg-white dark:bg-law-900 p-4 rounded-xl border border-law-200 dark:border-law-800 shadow-sm">
                                <div class="text-2xl font-bold text-green-600">3</div>
                                <div class="text-xs text-law-500 uppercase tracking-wide">Notes Added</div>
                            </div>
                            <div class="bg-white dark:bg-law-900 p-4 rounded-xl border border-law-200 dark:border-law-800 shadow-sm">
                                <div class="text-2xl font-bold text-purple-600">85%</div>
                                <div class="text-xs text-law-500 uppercase tracking-wide">Offline Ready</div>
                            </div>
                        </div>

                        <!-- Pinned Favorites -->
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold flex items-center gap-2">
                                    <svg class="w-5 h-5 text-gold-500" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>
                                    Pinned Favorites
                                </h2>
                                <button onclick="app.router('favorites')" class="text-sm text-gold-600 hover:underline">View All</button>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                ${pinnedBooks
                                  .map(
                                    (book) => `
                                    <div onclick="app.openBook('${book.id}')" class="group bg-white dark:bg-law-900 p-5 rounded-xl border border-law-200 dark:border-law-800 hover:border-gold-400 dark:hover:border-gold-500 cursor-pointer transition shadow-sm hover:shadow-law">
                                        <div class="flex items-start justify-between mb-3">
                                            <span class="px-2 py-1 rounded text-xs font-medium ${book.color}">${book.category}</span>
                                            <button onclick="event.stopPropagation(); app.toggleFavorite('${book.id}')" class="text-gold-500 hover:scale-110 transition">
                                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/></svg>
                                            </button>
                                        </div>
                                        <h3 class="font-bold text-law-900 dark:text-white mb-1 group-hover:text-gold-600 transition">${book.title}</h3>
                                        <p class="text-sm text-law-500">${book.totalSections} Sections</p>
                                        <div class="mt-4 flex items-center gap-2 text-xs text-law-400">
                                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                            Available Offline
                                        </div>
                                    </div>
                                `,
                                  )
                                  .join("")}
                            </div>
                        </div>

                        <!-- Continue Reading -->
                        <div class="mb-8">
                            <h2 class="text-lg font-bold mb-4">Continue Reading</h2>
                            <div class="bg-white dark:bg-law-900 rounded-xl border border-law-200 dark:border-law-800 p-4 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-lg flex items-center justify-center text-red-600">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-law-900 dark:text-white">Pakistan Penal Code, 1860</h3>
                                            <p class="text-sm text-law-500">Section 302 - Punishment for Murder</p>
                                            <div class="w-48 h-1.5 bg-law-200 dark:bg-law-800 rounded-full mt-2">
                                                <div class="w-3/4 h-full bg-gold-500 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="app.openBook('ppc', '302')" class="px-4 py-2 bg-law-900 dark:bg-white text-white dark:text-law-900 rounded-lg text-sm font-medium hover:opacity-90 transition">Resume</button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Access Categories -->
                        <div>
                            <h2 class="text-lg font-bold mb-4">Browse by Category</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                ${[
                                  "Criminal Law",
                                  "Civil Law",
                                  "Family Law",
                                  "Constitutional",
                                  "Revenue",
                                  "Taxation",
                                  "Evidence",
                                  "Property",
                                ]
                                  .map(
                                    (cat) => `
                                    <button onclick="app.router('library')" class="p-4 bg-white dark:bg-law-900 border border-law-200 dark:border-law-800 rounded-xl hover:border-gold-400 transition text-left group">
                                        <span class="block text-2xl mb-2 group-hover:scale-110 transition-transform">⚖️</span>
                                        <span class="text-sm font-semibold text-law-700 dark:text-law-300">${cat}</span>
                                    </button>
                                `,
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                `;
        },

        renderLibrary(container) {
          container.innerHTML = `
                    <div class="fade-in max-w-6xl mx-auto px-4 py-8 pb-24">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                            <div>
                                <h1 class="text-3xl font-serif font-bold text-law-900 dark:text-white">Law Library</h1>
                                <p class="text-law-600 dark:text-law-400 mt-1">Complete collection of Pakistani legal codes</p>
                            </div>
                            <div class="flex gap-2">
                                <select class="px-4 py-2 border border-law-300 dark:border-law-700 rounded-lg bg-white dark:bg-law-900 text-sm focus:outline-none focus:ring-2 focus:ring-gold-400">
                                    <option>All Categories</option>
                                    <option>Criminal Law</option>
                                    <option>Civil Law</option>
                                    <option>Constitutional</option>
                                </select>
                                <select class="px-4 py-2 border border-law-300 dark:border-law-700 rounded-lg bg-white dark:bg-law-900 text-sm focus:outline-none focus:ring-2 focus:ring-gold-400">
                                    <option>Sort by Name</option>
                                    <option>Sort by Year</option>
                                    <option>Recently Added</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${lawDB.books
                              .map(
                                (book) => `
                                <div class="bg-white dark:bg-law-900 rounded-xl border border-law-200 dark:border-law-800 p-5 hover:shadow-law transition group">
                                    <div class="flex items-start justify-between mb-4">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${book.color}">${book.category}</span>
                                        <button onclick="app.toggleFavorite('${book.id}')" class="text-law-400 hover:text-gold-500 transition ${app.state.favorites.has(book.id) ? "text-gold-500" : ""}">
                                            <svg class="w-5 h-5" fill="${app.state.favorites.has(book.id) ? "currentColor" : "none"}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                                        </button>
                                    </div>
                                    <h3 class="font-bold text-lg text-law-900 dark:text-white mb-2 line-clamp-2">${book.title}</h3>
                                    <div class="flex items-center gap-4 text-sm text-law-500 mb-4">
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                            ${book.totalSections} sections
                                        </span>
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                            Updated 2024
                                        </span>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="app.openBook('${book.id}')" class="flex-1 py-2.5 bg-law-900 dark:bg-white text-white dark:text-law-900 rounded-lg text-sm font-medium hover:opacity-90 transition">Read</button>
                                        <button onclick="app.downloadBook('${book.id}')" class="px-3 py-2.5 border border-law-300 dark:border-law-700 rounded-lg hover:bg-law-50 dark:hover:bg-law-800 transition" title="Download">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        </button>
                                    </div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        },

        renderBookReader(container, bookId, sectionId = null) {
          this.state.activeBook = bookId;
          const book = lawDB.books.find((b) => b.id === bookId);
          const sections = lawDB.getSections(bookId);
          this.state.activeSection = sectionId || sections[0].num;

          const currentSection = sections.find(
            (s) => s.num === this.state.activeSection,
          );
          const currentIndex = sections.findIndex(
            (s) => s.num === this.state.activeSection,
          );

          container.className =
            "flex-1 flex overflow-hidden bg-white dark:bg-law-950";

          container.innerHTML = `
                    <!-- Sidebar TOC -->
                    <aside class="w-72 bg-law-50 dark:bg-law-900 border-r border-law-200 dark:border-law-800 flex-none flex flex-col hidden lg:flex">
                        <div class="p-4 border-b border-law-200 dark:border-law-800 bg-white dark:bg-law-900">
                            <button onclick="app.router('library')" class="text-xs text-law-500 hover:text-gold-600 mb-1 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                Back to Library
                            </button>
                            <h2 class="font-bold text-sm leading-tight">${book.title}</h2>
                        </div>
                        
                        <div class="p-3 border-b border-law-200 dark:border-law-800">
                            <div class="relative">
                                <input type="text" placeholder="Jump to section..." 
                                    class="w-full pl-8 pr-3 py-2 bg-white dark:bg-law-800 border border-law-300 dark:border-law-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-gold-400"
                                    onkeyup="if(event.key==='Enter') app.jumpToSection(this.value)">
                                <svg class="w-4 h-4 text-law-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto py-2">
                            ${sections
                              .map(
                                (s, idx) => `
                                <button onclick="app.loadSection('${s.num}')" 
                                    class="w-full text-left px-4 py-2.5 text-sm hover:bg-law-100 dark:hover:bg-law-800 transition flex items-center gap-3 ${s.num === this.state.activeSection ? "bg-white dark:bg-law-950 border-l-3 border-gold-500 shadow-sm" : "text-law-600 dark:text-law-400 border-l-3 border-transparent"}">
                                    <span class="font-mono text-xs w-8 text-law-400">${s.num}</span>
                                    <span class="truncate ${s.num === this.state.activeSection ? "font-semibold text-law-900 dark:text-white" : ""}">${s.title}</span>
                                    ${this.state.annotations[`${bookId}-${s.num}`] ? '<span class="ml-auto w-2 h-2 bg-gold-500 rounded-full"></span>' : ""}
                                </button>
                            `,
                              )
                              .join("")}
                        </div>
                    </aside>

                    <!-- Main Reader -->
                    <main class="flex-1 flex flex-col min-w-0">
                        <!-- Reader Toolbar -->
                        <div class="h-14 border-b border-law-200 dark:border-law-800 flex items-center justify-between px-4 bg-white dark:bg-law-900 sticky top-0 z-10">
                            <div class="flex items-center gap-2">
                                <button onclick="app.router('library')" class="lg:hidden p-2 hover:bg-law-100 dark:hover:bg-law-800 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                                </button>
                                <div class="hidden sm:block">
                                    <div class="flex items-center gap-2 text-sm text-law-500">
                                        <span>Library</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                        <span class="text-law-900 dark:text-white font-medium">${book.title}</span>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                        <span class="text-gold-600 font-medium">Sec ${currentSection.num}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex items-center gap-1">
                                <div class="hidden md:flex items-center bg-law-100 dark:bg-law-800 rounded-lg p-1 mr-2">
                                    <button onclick="app.changeFontSize(-1)" class="px-2 py-1 hover:bg-white dark:hover:bg-law-700 rounded text-sm">A-</button>
                                    <button onclick="app.changeFontSize(1)" class="px-2 py-1 hover:bg-white dark:hover:bg-law-700 rounded text-sm font-bold">A+</button>
                                </div>
                                
                                <button onclick="app.copySection()" class="p-2 hover:bg-law-100 dark:hover:bg-law-800 rounded-lg text-law-500" title="Copy Section">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                </button>
                                
                                <button onclick="app.toggleBookmark()" class="p-2 hover:bg-law-100 dark:hover:bg-law-800 rounded-lg ${this.state.bookmarks.has(`${bookId}-${currentSection.num}`) ? "text-gold-500" : "text-law-500"}" title="Bookmark">
                                    <svg class="w-5 h-5" fill="${this.state.bookmarks.has(`${bookId}-${currentSection.num}`) ? "currentColor" : "none"}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                                </button>

                                <button onclick="app.shareSection()" class="p-2 hover:bg-law-100 dark:hover:bg-law-800 rounded-lg text-law-500" title="Share">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 overflow-y-auto" id="reader-scroll">
                            <article class="max-w-3xl mx-auto px-6 py-12 ${this.state.fontSize} ${this.state.lineHeight} font-serif text-law-900 dark:text-law-100 prose-law">
                                <header class="mb-8 pb-8 border-b border-law-200 dark:border-law-800">
                                    <div class="flex items-center gap-2 mb-4">
                                        <span class="px-3 py-1 bg-gold-100 dark:bg-gold-900/30 text-gold-800 dark:text-gold-400 rounded-full text-sm font-bold font-sans">Section ${currentSection.num}</span>
                                        ${this.state.annotations[`${bookId}-${currentSection.num}`] ? '<span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400 rounded-full text-sm font-sans">Has Notes</span>' : ""}
                                    </div>
                                    <h1 class="text-3xl md:text-4xl font-bold mb-4 font-sans">${currentSection.title}</h1>
                                    <div class="flex items-center gap-4 text-sm text-law-500 font-sans">
                                        <span>${book.title}</span>
                                        <span>•</span>
                                        <span>${new Date().toLocaleDateString()}</span>
                                    </div>
                                </header>

                                <div id="section-text" class="relative">
                                    ${this.highlightSearchTerms(currentSection.content)}
                                    
                                    ${
                                      this.state.annotations[
                                        `${bookId}-${currentSection.num}`
                                      ]
                                        ? `
                                        <div class="mt-8 p-4 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 rounded-r-lg">
                                            <div class="flex items-center gap-2 mb-2 text-yellow-800 dark:text-yellow-400 font-sans font-semibold text-sm">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                                Your Note
                                            </div>
                                            <p class="text-law-700 dark:text-law-300 italic">${this.state.annotations[`${bookId}-${currentSection.num}`]}</p>
                                        </div>
                                    `
                                        : ""
                                    }
                                </div>

                                <!-- Navigation -->
                                <div class="mt-12 pt-8 border-t border-law-200 dark:border-law-800 flex justify-between items-center">
                                    ${
                                      currentIndex > 0
                                        ? `
                                        <button onclick="app.loadSection('${sections[currentIndex - 1].num}')" class="text-left group">
                                            <span class="block text-xs text-law-500 uppercase tracking-wide mb-1">Previous</span>
                                            <span class="font-bold text-law-900 dark:text-white group-hover:text-gold-600 transition">§ ${sections[currentIndex - 1].num} ${sections[currentIndex - 1].title}</span>
                                        </button>
                                    `
                                        : "<div></div>"
                                    }
                                    
                                    ${
                                      currentIndex < sections.length - 1
                                        ? `
                                        <button onclick="app.loadSection('${sections[currentIndex + 1].num}')" class="text-right group">
                                            <span class="block text-xs text-law-500 uppercase tracking-wide mb-1">Next Section</span>
                                            <span class="font-bold text-law-900 dark:text-white group-hover:text-gold-600 transition">§ ${sections[currentIndex + 1].num} ${sections[currentIndex + 1].title}</span>
                                        </button>
                                    `
                                        : "<div></div>"
                                    }
                                </div>
                            </article>
                        </div>
                    </main>

                    <!-- Context Menu for Text Selection -->
                    <div id="context-menu" class="fixed hidden bg-law-900 text-white rounded-lg shadow-law-lg p-2 z-50 transform -translate-x-1/2 -translate-y-full mt-[-10px]">
                        <div class="flex gap-1">
                            <button onclick="app.highlightSelection()" class="px-3 py-1.5 hover:bg-law-700 rounded text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                                Highlight
                            </button>
                            <button onclick="app.openAnnotationModal()" class="px-3 py-1.5 hover:bg-law-700 rounded text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                Note
                            </button>
                            <button onclick="app.copySelection()" class="px-3 py-1.5 hover:bg-law-700 rounded text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy
                            </button>
                        </div>
                        <div class="absolute bottom-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-law-900 rotate-45"></div>
                    </div>
                `;

          // Restore scroll position if any
          setTimeout(() => {
            const scrollArea = document.getElementById("reader-scroll");
            if (scrollArea) scrollArea.scrollTop = 0;
          }, 100);
        },

        renderFavorites(container) {
          const favBooks = lawDB.books.filter((b) =>
            this.state.favorites.has(b.id),
          );
          container.innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto px-4 py-8">
                        <h1 class="text-3xl font-serif font-bold mb-6">Pinned Favorites</h1>
                        ${favBooks.length === 0 ? '<p class="text-law-500">No favorites yet. Pin books from the library.</p>' : ""}
                        <div class="space-y-4">
                            ${favBooks
                              .map(
                                (book) => `
                                <div class="bg-white dark:bg-law-900 p-4 rounded-xl border border-law-200 dark:border-law-800 flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 ${book.color} rounded-lg flex items-center justify-center">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-law-900 dark:text-white">${book.title}</h3>
                                            <p class="text-sm text-law-500">${book.totalSections} sections • ${book.category}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="app.openBook('${book.id}')" class="px-4 py-2 bg-gold-500 text-white rounded-lg hover:bg-gold-600 transition">Read</button>
                                        <button onclick="app.toggleFavorite('${book.id}')" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                                        </button>
                                    </div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        },

        renderFolders(container) {
          container.innerHTML = `
                    <div class="fade-in max-w-4xl mx-auto px-4 py-8">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-3xl font-serif font-bold">Smart Folders</h1>
                            <button onclick="app.createFolder()" class="px-4 py-2 bg-gold-500 text-white rounded-lg hover:bg-gold-600 transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                New Folder
                            </button>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-white dark:bg-law-900 p-5 rounded-xl border border-law-200 dark:border-law-800 hover:shadow-law transition cursor-pointer">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                                    </div>
                                    <h3 class="font-bold">Criminal Cases 2024</h3>
                                </div>
                                <p class="text-sm text-law-500 mb-3">12 items • Last updated 2 hours ago</p>
                                <div class="flex gap-2">
                                    <span class="px-2 py-1 bg-law-100 dark:bg-law-800 rounded text-xs">PPC</span>
                                    <span class="px-2 py-1 bg-law-100 dark:bg-law-800 rounded text-xs">CrPC</span>
                                </div>
                            </div>
                            
                            <div class="bg-white dark:bg-law-900 p-5 rounded-xl border border-law-200 dark:border-law-800 hover:shadow-law transition cursor-pointer">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 text-green-600 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                                    </div>
                                    <h3 class="font-bold">Property Disputes</h3>
                                </div>
                                <p class="text-sm text-law-500 mb-3">8 items • Last updated yesterday</p>
                                <div class="flex gap-2">
                                    <span class="px-2 py-1 bg-law-100 dark:bg-law-800 rounded text-xs">Transfer of Property</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        },

        renderProfile(container) {
          container.innerHTML = `
                    <div class="fade-in max-w-2xl mx-auto px-4 py-8">
                        <h1 class="text-3xl font-serif font-bold mb-6">Profile & Settings</h1>
                        
                        <div class="bg-white dark:bg-law-900 rounded-xl border border-law-200 dark:border-law-800 p-6 mb-6">
                            <h2 class="font-bold mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                Account
                            </h2>
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-16 h-16 bg-law-700 rounded-full flex items-center justify-center text-white text-2xl font-bold">DP</div>
                                <div>
                                    <h3 class="font-bold text-lg">Advocate Dev Parkash</h3>
                                    <p class="text-law-500">High Court Circut bench HYD</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-law-900 rounded-xl border border-law-200 dark:border-law-800 p-6 mb-6">
                            <h2 class="font-bold mb-4">Reading Preferences</h2>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span>Default Font Size</span>
                                    <select class="px-3 py-1 border rounded-lg bg-law-50 dark:bg-law-800">
                                        <option>Medium</option>
                                        <option>Large</option>
                                        <option>Extra Large</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Line Spacing</span>
                                    <select class="px-3 py-1 border rounded-lg bg-law-50 dark:bg-law-800">
                                        <option>Comfortable</option>
                                        <option>Compact</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span>Auto-save Bookmarks</span>
                                    <input type="checkbox" checked class="w-5 h-5 text-gold-500 rounded">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-law-900 rounded-xl border border-law-200 dark:border-law-800 p-6">
                            <h2 class="font-bold mb-4 text-red-600">Danger Zone</h2>
                            <button onclick="app.clearData()" class="text-red-600 hover:underline text-sm">Clear all local data</button>
                        </div>
                    </div>
                `;
        },

        // Actions
        openBook(bookId, sectionId = null) {
          this.router("book", { bookId, sectionId });
        },

        loadSection(num) {
          this.state.activeSection = num;
          this.router("book", {
            bookId: this.state.activeBook,
            sectionId: num,
          });
        },

        jumpToSection(val) {
          const sections = lawDB.getSections(this.state.activeBook);
          const matched = sections.find(
            (s) => s.num === val || s.num.includes(val),
          );
          if (matched) {
            this.loadSection(matched.num);
          } else {
            this.showToast("Section not found");
          }
        },

        toggleFavorite(bookId) {
          if (this.state.favorites.has(bookId)) {
            this.state.favorites.delete(bookId);
          } else {
            this.state.favorites.add(bookId);
          }
          this.showToast(
            this.state.favorites.has(bookId)
              ? "Added to favorites"
              : "Removed from favorites",
          );
          this.router(this.state.currentView); // Re-render
        },

        toggleBookmark() {
          const key = `${this.state.activeBook}-${this.state.activeSection}`;
          if (this.state.bookmarks.has(key)) {
            this.state.bookmarks.delete(key);
            this.showToast("Bookmark removed");
          } else {
            this.state.bookmarks.add(key);
            this.showToast("Section bookmarked");
          }
          this.router("book", { bookId: this.state.activeBook });
        },

        toggleDarkMode() {
          this.state.darkMode = !this.state.darkMode;
          document.documentElement.classList.toggle("dark");
          localStorage.setItem("darkMode", this.state.darkMode);
        },

        changeFontSize(delta) {
          const sizes = [
            "text-sm",
            "text-base",
            "text-lg",
            "text-xl",
            "text-2xl",
          ];
          const current = sizes.indexOf(this.state.fontSize);
          const next = current + delta;
          if (next >= 0 && next < sizes.length) {
            this.state.fontSize = sizes[next];
            this.router("book", { bookId: this.state.activeBook });
          }
        },

        copySection() {
          const text = document.getElementById("section-text").innerText;
          navigator.clipboard.writeText(text);
          this.showToast("Section copied to clipboard");
        },

        shareSection() {
          if (navigator.share) {
            navigator.share({
              title: `Section ${this.state.activeSection}`,
              text:
                document
                  .getElementById("section-text")
                  .innerText.substring(0, 100) + "...",
              url: window.location.href,
            });
          } else {
            navigator.clipboard.writeText(window.location.href);
            this.showToast("Link copied to clipboard");
          }
        },

        downloadBook(bookId) {
          this.showToast(
            `Downloading ${bookId.toUpperCase()} for offline reading...`,
          );
          setTimeout(() => this.showToast("Download complete"), 1500);
        },

        downloadOffline() {
          this.showToast("Preparing offline package...");
        },

        // Search Modal
        showSearchModal() {
          document.getElementById("search-modal").classList.remove("hidden");
          document.getElementById("modal-search-input").focus();
        },

        hideSearchModal() {
          document.getElementById("search-modal").classList.add("hidden");
        },

        performSearch(query) {
          const container = document.getElementById("search-results-container");
          if (!query.trim()) {
            container.innerHTML =
              '<div class="p-8 text-center text-law-500">Start typing to search...</div>';
            return;
          }

          // Mock search results
          const results = [
            {
              book: "Pakistan Penal Code",
              section: "302",
              title: "Punishment for Murder",
              preview:
                "Whoever commits qatl-i-amd shall, subject to the provisions...",
            },
            {
              book: "Code of Criminal Procedure",
              section: "154",
              title: "Information in cognizable cases",
              preview:
                "Every information relating to the commission of a cognizable offence...",
            },
          ].filter(
            (r) =>
              r.preview.toLowerCase().includes(query.toLowerCase()) ||
              r.section.includes(query),
          );

          if (results.length === 0) {
            container.innerHTML = `<div class="p-8 text-center text-law-500">No results for "${query}"</div>`;
          } else {
            container.innerHTML = results
              .map(
                (r) => `
                        <div onclick="app.openBook('ppc', '${r.section}'); app.hideSearchModal()" class="p-4 hover:bg-law-50 dark:hover:bg-law-800 cursor-pointer border-b border-law-100 dark:border-law-800 last:border-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-gold-600">${r.book}</span>
                                <span class="text-xs text-law-400">•</span>
                                <span class="text-xs font-mono text-law-500">Sec ${r.section}</span>
                            </div>
                            <h4 class="font-semibold text-law-900 dark:text-white mb-1">${r.title}</h4>
                            <p class="text-sm text-law-500">${r.preview}</p>
                        </div>
                    `,
              )
              .join("");
          }
        },

        highlightSearchTerms(content) {
          if (!this.state.searchQuery) return content;
          const regex = new RegExp(`(${this.state.searchQuery})`, "gi");
          return content.replace(
            regex,
            '<mark class="search-highlight">$1</mark>',
          );
        },

        // Text Selection & Annotation
        setupTextSelection() {
          document.addEventListener("selectionchange", () => {
            const selection = window.getSelection();
            const menu = document.getElementById("context-menu");

            if (
              selection.toString().trim().length > 0 &&
              this.state.currentView === "book"
            ) {
              const range = selection.getRangeAt(0);
              const rect = range.getBoundingClientRect();

              menu.style.left = `${rect.left + rect.width / 2}px`;
              menu.style.top = `${rect.top}px`;
              menu.classList.remove("hidden");
            } else if (menu) {
              menu.classList.add("hidden");
            }
          });
        },

        highlightSelection() {
          // Implementation would wrap selected text in highlight span
          this.showToast("Text highlighted");
          document.getElementById("context-menu").classList.add("hidden");
        },

        openAnnotationModal() {
          document
            .getElementById("annotation-modal")
            .classList.remove("hidden");
          document.getElementById("annotation-modal").classList.add("flex");
          document.getElementById("annotation-text").focus();
        },

        closeAnnotationModal() {
          document.getElementById("annotation-modal").classList.add("hidden");
          document.getElementById("annotation-modal").classList.remove("flex");
        },

        saveAnnotation() {
          const text = document.getElementById("annotation-text").value;
          const key = `${this.state.activeBook}-${this.state.activeSection}`;
          this.state.annotations[key] = text;
          this.closeAnnotationModal();
          this.showToast("Note saved");
          this.router("book", { bookId: this.state.activeBook });
        },

        copySelection() {
          const text = window.getSelection().toString();
          navigator.clipboard.writeText(text);
          this.showToast("Copied to clipboard");
          document.getElementById("context-menu").classList.add("hidden");
        },

        // Utilities
        showToast(message) {
          const toast = document.getElementById("toast");
          document.getElementById("toast-message").textContent = message;
          toast.classList.remove("translate-y-20", "opacity-0");
          setTimeout(() => {
            toast.classList.add("translate-y-20", "opacity-0");
          }, 3000);
        },

        setupKeyboardShortcuts() {
          document.addEventListener("keydown", (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === "k") {
              e.preventDefault();
              this.showSearchModal();
            }
            if (e.key === "Escape") {
              this.hideSearchModal();
              this.closeAnnotationModal();
            }
            if (
              e.key === "ArrowLeft" &&
              e.altKey &&
              this.state.currentView === "book"
            ) {
              // Previous section logic
            }
            if (
              e.key === "ArrowRight" &&
              e.altKey &&
              this.state.currentView === "book"
            ) {
              // Next section logic
            }
          });
        },

        createFolder() {
          const name = prompt("Enter folder name:");
          if (name) this.showToast(`Folder "${name}" created`);
        },

        clearData() {
          if (confirm("Clear all data?")) {
            this.state.bookmarks.clear();
            this.state.annotations = {};
            this.showToast("All data cleared");
          }
        },
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        app.init();
      });
    </script>
  </body>
</html>
